pipeline {
    agent any

    environment {
        KUBECONFIG = "/var/jenkins_home/.kube/config"
    }

    tools {
        maven "M3"
        jdk "JDK21"
    }

    triggers {
        githubPush()
    }

    stages {
        stage('Git Clone') {
            steps {
                sh 'rm -rf spring-petclinic' // 기존 디렉토리 제거 (중복 방지)
                sh 'git clone https://github.com/lhj1230/spring-petclinic.git'
            }
        }

        stage('Maven Build') {
            steps {
                dir('spring-petclinic') {
                    echo 'Maven Build'
                    sh 'mvn -Dmaven.test.failure.ignore=true clean package'
                }
            }
            post {
                success {
                    echo 'Build Success'
                }
                failure {
                    echo 'Build Fail'
                }
            }
        }

        stage('Delete Existing K8s Resources') {
            steps {
                dir('spring-petclinic/k8s') {
                    sh '''
                        kubectl delete -f petclinic.yml --ignore-not-found
                        kubectl delete -f db.yml --ignore-not-found
                    '''
                }
            }
        }

        stage('Deploy YAMLs') {
            steps {
                dir('spring-petclinic/k8s') {
                    sh 'kubectl apply -f db.yml'
                    sh 'kubectl apply -f petclinic.yml'
                }
            }
        }

        stage('Check Pod Status') {
            steps {
                sh 'kubectl get pods -l app=spring-petclinic'
            }
        }
    }
}
