pipeline {
    agent any

    environment {
        KUBECONFIG = "/var/jenkins_home/.kube/config"
        JAVA_OPTS = "-Dorg.jenkinsci.plugins.durabletask.BourneShellScript.HEARTBEAT_CHECK_INTERVAL=86400"
    }

    tools {
        maven "M3"
        jdk "JDK21"
    }

    triggers {
        githubPush()
    }

    stages {
        stage('Git Clone') {
            steps {
                // ê¸°ì¡´ spring-petclinic ë””ë ‰í† ë¦¬ ì œê±° í›„ clone
                sh '''
                    rm -rf spring-petclinic
                    git clone https://github.com/lhj1230/spring-petclinic.git
                '''
            }
        }

        stage('Maven Build') {
            steps {
                dir('spring-petclinic') {
                    echo 'ğŸ”¨ Maven Build (without test)'
                    sh 'mvn clean compile package -DskipTests=true'
                }
            }
        }

        stage('Maven Test') {
            steps {
                dir('spring-petclinic') {
                    echo 'ğŸ§ª Running Tests (with timeout)'
                    timeout(time: 5, unit: 'MINUTES') {
                        sh 'mvn test'
                    }
                }
            }
        }

        stage('Deploy YAMLs') {
            steps {
                dir('spring-petclinic/k8s') {  // `db.yml`, `petclinic.yml`ì´ ìˆëŠ” ê²½ë¡œ
                    echo 'ğŸš€ Deploying YAMLs to Kubernetes'
                    sh 'kubectl apply -f db.yml'
                    sh 'kubectl apply -f petclinic.yml'
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… Pipeline Success'
        }
        failure {
            echo 'âŒ Pipeline Failed'
        }
    }
}
