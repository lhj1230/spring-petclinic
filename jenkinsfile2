pipeline {
    agent any

    environment {
        KUBECONFIG = "/var/jenkins_home/.kube/config"
        JAVA_OPTS = "-Dorg.jenkinsci.plugins.durabletask.BourneShellScript.HEARTBEAT_CHECK_INTERVAL=86400"
    }

    tools {
        maven "M3"
        jdk "JDK21"
    }

    triggers {
        githubPush()
    }

    stages {
        stage('Git Clone') {
            steps {
                sh 'git clone https://github.com/lhj1230/spring-petclinic.git'
            }
        }

        stage('Maven Build') {
            steps {
                dir('spring-petclinic') {
                    echo 'Maven Build (without test)'
                    sh 'mvn clean compile package -DskipTests=true'
                }
            }
        }

        stage('Maven Test') {
            steps {
                dir('spring-petclinic') {
                    echo 'Running Tests (with timeout)'
                    timeout(time: 5, unit: 'MINUTES') {
                        sh 'mvn test'
                    }
                }
            }
        }

        stage('Deploy YAMLs') {
            steps {
                dir('spring-petclinic/k8s') {
                    sh 'kubectl apply -f .'
                }
            }
        }
    }

    post {
        success {
            echo 'Pipeline Success'
        }
        failure {
            echo 'Pipeline Failed'
        }
    }
}
